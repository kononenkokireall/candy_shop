from typing import Optional, Dict, Tuple

from aiogram.types import InlineKeyboardButton, InlineKeyboardMarkup
from aiogram.utils.keyboard import InlineKeyboardBuilder

from keyboards.inline_main import MenuCallBack


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
def get_user_product_btn(
        *,
        level: int,
        category: int,
        page: int,
        pagination_btn: Optional[Dict[str, str]] = None,
        product_id: int,
        sizes: Tuple[int, ...] = (2, 1),
) -> InlineKeyboardMarkup:
    """
    –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–æ–≤–∞—Ä–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
    - level: –¢–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –º–µ–Ω—é (–∏—Å–ø. –î–ª—è —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è callback-–¥–∞–Ω–Ω—ã—Ö).
    - category: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –∫ –∫–æ—Ç–æ—Ä–æ–π –æ—Ç–Ω–æ—Å–∏—Ç—Å—è —Ç–æ–≤–∞—Ä.
    - page: –¢–µ–∫—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏.
    - pagination_btn: –°–ª–æ–≤–∞—Ä—å, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π –∫–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏.
     –ö–ª—é—á ‚Äî —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏, –∑–Ω–∞—á–µ–Ω–∏–µ ‚Äî –¥–µ–π—Å—Ç–≤–∏–µ ('next' –∏–ª–∏ 'prev').
                      –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å.
    - product_id: –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–æ–≤–∞—Ä–∞,
     –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –ø–æ–∫—É–ø–∫–∏.
    - sizes: –ö–æ—Ä—Ç–µ–∂, –æ–ø—Ä–µ–¥–µ–ª—è—é—â–∏–π –∫–æ–º–ø–æ–Ω–æ–≤–∫—É –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–Ω–æ–ø–æ–∫
     (–Ω–∞–ø—Ä–∏–º–µ—Ä, (2, 1) –æ–∑–Ω–∞—á–∞–µ—Ç –¥–≤–∞ —Ä—è–¥–∞: –≤ –ø–µ—Ä–≤–æ–º —Ä—è–¥—É –ø–æ 2 –∫–Ω–æ–ø–∫–∏,
      –≤–æ –≤—Ç–æ—Ä–æ–º ‚Äî 1).

    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
    - –†–∞–∑–º–µ—Ç–∫—É inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã,
     —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω—É—é —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º InlineKeyboardBuilder.
    """
    # –°–æ–∑–¥–∞–µ–º –±–∏–ª–¥–µ—Ä –¥–ª—è inline-–∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    keyboard = InlineKeyboardBuilder()

    # –î–æ–±–∞–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏:
    # 1. "‚óÄÔ∏è–í–µ—Ä–Ω—É—Ç—Å—è" ‚Äî –∫–Ω–æ–ø–∫–∞ –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –º–µ–Ω—é
    # (—É—Ä–æ–≤–µ–Ω—å —É–º–µ–Ω—å—à–∞–µ—Ç—Å—è –Ω–∞ 1)
    # 2. "–ö–æ—Ä–∑–∏–Ω–∞ üõí" ‚Äî –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
    # (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å 3 –∏ –∏–º—è –º–µ–Ω—é "cart")
    # 3. "–ö—É–ø–∏—Ç—å üíµ" ‚Äî –∫–Ω–æ–ø–∫–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É
    # (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π product_id)
    keyboard.add(
        InlineKeyboardButton(
            text="‚óÄÔ∏è–í–µ—Ä–Ω—É—Ç—å—Å—è",
            callback_data=MenuCallBack(level=level - 1,
                                       menu_name="catalog").pack(),
        ),
        InlineKeyboardButton(
            text="–ö–æ—Ä–∑–∏–Ω–∞ üõí",
            callback_data=MenuCallBack(level=3, menu_name="cart", page=1,
                                       ).pack(),
        ),
        InlineKeyboardButton(
            text="–ö—É–ø–∏—Ç—å üíµ",
            callback_data=MenuCallBack(
                level=level, menu_name="add_to_cart", product_id=product_id
            ).pack(),
        ),
    )

    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö
    # –∫–Ω–æ–ø–æ–∫ —Å–æ–≥–ª–∞—Å–Ω–æ –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º —Ä–∞–∑–º–µ—Ä–∞–º (sizes).
    # –ú–µ—Ç–æ–¥ adjust —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∏
    # –ø–æ —Ä—è–¥–∞–º –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –∑–∞–¥–∞–Ω–Ω–æ–π –∫–æ–º–ø–æ–Ω–æ–≤–∫–æ–π.
    keyboard.adjust(*sizes)

    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏.
    # –ï—Å–ª–∏ pagination_btn —Ä–∞–≤–µ–Ω None, –∑–∞–º–µ–Ω—è–µ–º –µ–≥–æ –Ω–∞ –ø—É—Å—Ç–æ–π —Å–ª–æ–≤–∞—Ä—å.
    pagination_btn = pagination_btn or {}
    pagination_row = []  # –°–ø–∏—Å–æ–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–Ω–æ–ø–æ–∫ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏

    # –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –ø–∞—Ä—ã (—Ç–µ–∫—Å—Ç, –¥–µ–π—Å—Ç–≤–∏–µ) –∏–∑ —Å–ª–æ–≤–∞—Ä—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
    for text, action in pagination_btn.items():
        # –ï—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ 'next', —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ 1
        if action == "next":
            new_page = page + 1
        # –ï—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ 'prev', —É–º–µ–Ω—å—à–∞–µ–º –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ 1
        elif action == "prev":
            new_page = page - 1
        else:
            # –ï—Å–ª–∏ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç 'next' –∏–ª–∏ 'prev',
            # –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –¥–∞–Ω–Ω—É—é –∫–Ω–æ–ø–∫—É
            continue

        # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ —Å –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –∏ callback-–¥–∞–Ω–Ω—ã–º–∏,
        # –≤–∫–ª—é—á–∞—é—â–∏–º–∏ —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å,
        # –¥–µ–π—Å—Ç–≤–∏–µ, –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏ –Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        pagination_row.append(
            InlineKeyboardButton(
                text=text,
                callback_data=MenuCallBack(
                    level=level, menu_name=action, category=category,
                    page=new_page
                ).pack(),
            )
        )

    # –ï—Å–ª–∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã –∫–Ω–æ–ø–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏,
    # –¥–æ–±–∞–≤–ª—è–µ–º –∏—Ö –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä—è–¥ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    if pagination_row:
        keyboard.row(*pagination_row)

    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Ç–æ–≥–æ–≤—É—é —Ä–∞–∑–º–µ—Ç–∫—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
    return keyboard.as_markup()
